---
title: "Formants and VOT"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
library(emuR)
library(wrassp)
library(tidyverse)
```

## Prepare emuDB

```{r emudb}
path <- "./data/alb-ipa_emuDB"
path2 <- "./data/dataframes"
db <- load_emuDB(path, verbose = TRUE)

db_int <- load_emuDB("./data/alb-ipa-int_emuDB", verbose = TRUE)
```

## Formants

First, we query the emuDB to get the vowels in the relevant example words.

```{r vow}
vow <- query(
  db,
  "[MAU == p -> #MAU == e| i | y | u | @ | o | a]",
  bundlePattern = "[0-9]*-(peri|por|puro|pyk3|pik3|p3r|para)"
)
word <- requery_hier(db, vow, "ORT-MAU")
vow$word <- word$labels
```

Now we can get formants from the midpoint of the vowels.

```{r formants}
formants <- get_trackdata(
  db,
  seglist = vow,
  cut = 0.5,
  npoints = 1,
  ssffTrackName = "FORMANTS",
  resultType = "tibble"
)
formants <- formants[ , -which(names(formants) %in% c("T4", "T5"))]
formants <- formants[ which(formants$session != "s03"), ]
```

We now clean, rearrange and save the tibble.

```{r clean-formants}
formants$gender <- recode(formants$session, "s01" = "F", "s02" = "M", "s04" = "F", "s05" = "M", "s06" = "M")

formants <- formants %>%
  rename(
    F1 = T1,
    F2 = T2,
    F3 = T3,
    vowel = labels,
    speaker = session
  )

formants <- formants[ , -which(names(formants) %in% c("sl_rowIdx", "db_uuid","session", "level", "attribute", "start_item_id", "end_item_id", "start_item_seq_idx", "end_item_seq_idx", "type", "sample_rate", "times_rel", "times_norm"))]

formants <- formants %>%
  select(speaker, gender, vowel, word, bundle, F1, F2, F3, start, end, sample_start, sample_end, times_orig)
```

```{r save-formants}
saveRDS(formants, file = file.path(path2, "formants.rds"))
```

## Formants from all vowels

First, we query the emuDB to get the vowels in the relevant example words.

```{r vow-all}
vow_all <- query(
  db,
  "[MAU == p -> #MAU == e| i | y | u | @ | o | a]"
)
word <- requery_hier(db, vow_all, "ORT-MAU")
vow_all$word <- word$labels
```

Now we can get formants from the midpoint of the vowels.

```{r formants-all}
formants_all <- get_trackdata(
  db,
  seglist = vow_all,
  cut = 0.5,
  npoints = 1,
  ssffTrackName = "FORMANTS",
  resultType = "tibble"
)
formants_all <- formants_all[ , -which(names(formants_all) %in% c("T4", "T5"))]
formants_all <- formants_all[ which(formants_all$session != "s03"), ]
```

We now clean, rearrange and save the tibble.

```{r clean-formants-all}
formants_all$gender <- recode(formants_all$session, "s01" = "F", "s02" = "M", "s04" = "F", "s05" = "M", "s06" = "M")

formants_all <- formants_all %>%
  rename(
    F1 = T1,
    F2 = T2,
    F3 = T3,
    vowel = labels,
    speaker = session
  )

formants_all <- formants_all[ , -which(names(formants_all) %in% c("sl_rowIdx", "db_uuid","session", "level", "attribute", "start_item_id", "end_item_id", "start_item_seq_idx", "end_item_seq_idx", "type", "sample_rate", "times_rel", "times_norm"))]

formants_all <- formants_all %>%
  select(speaker, gender, vowel, word, bundle, F1, F2, F3, start, end, sample_start, sample_end, times_orig)
```

```{r save-formants-all}
saveRDS(formants_all, file = file.path(path2, "formants_all.rds"))
```

## VOT

Quesry the database for the releases.

```{r rels}
rels = query(db, "RELS =~ .*", calcTimes = T)
word2 = requery_hier(db, rels, "ORT-MAU")
rels$word = word2$labels
voi = query(db, "VOI =~ .*", calcTimes = T)
```

Let's calculate VOT.

```{r vot}
rels$tomatch = paste(rels$session, rels$bundle)
voi$tomatch = paste(voi$session, voi$bundle)
m = match(as.character(rels$tomatch), as.character(voi$tomatch))
vot = data.frame(rels, voicing = voi$start[m])
vot$VOT = (vot$voicing - as.numeric(vot$start))
vot$consonant = as.character(substr(vot$word, 1, 1))
```

We now clean, rearrange, and save the tibble.

```{r clean-vot}
vot$gender <- recode(vot$session, "s01" = "F", "s02" = "M", "s04" = "F", "s05" = "M", "s06" = "M")

vot <- vot %>%
  rename(
    release = start,
    speaker = session
  )

vot = vot[ , -which(names(vot) %in% c("labels", "end", "db_uuid","session", "level", "attribute", "start_item_id", "end_item_id", "start_item_seq_idx", "end_item_seq_idx", "type", "sample_rate", "tomatch", "sample_start", "sample_end"))]
columns2 <- c("speaker", "gender", "consonant", "word", "bundle", "VOT", "release", "voicing")
vot <- vot[, columns2]

vot <- vot %>%
  select(speaker, gender, consonant, word, bundle, VOT, release, voicing)
```

```{r save-vot}
saveRDS(vot, file = file.path(path2, "vot.rds"))
```

## F0

First, we query the emuDB to get the relevant sentences.

```{r vow-f0}
pros <- query(db, "MAU !~ <p:>", bundlePattern = "[0-9]*-(broad*|polar*|narrow*)", calcTimes = TRUE)
pross <- requery_hier(db, pros, "ORT-MAU")
pros$word <- pross$labels
pros <- pros[ which(pros$labels != ""), ]
proso <- get_trackdata(db, seglist = pros, ssffTrackName = "F0")
proso <- proso[ which(proso$session != "s03"), ]
```

The we time normalise time per token.

```{r norm}
proso$token <- paste(proso$session, proso$bundle)
proso <- proso %>%
  group_by(token) %>%
  mutate(
    sentence_dur = max(end) - min(start),
    norm_timepoint = ((times_orig - (min(start)))/sentence_dur)
  )
```

We can add info for speaker and sentence

```{r speaker-sentence}
proso$gender <- recode(
  proso$session,
  "s01" = "F",
  "s02" = "M",
  "s04" = "F",
  "s05" = "M",
  "s06" = "M"
)
proso <- proso %>%
  rename(
    "f0" = "T1",
    "segment" = "labels",
    "speaker" = "session"
  )

proso <- proso %>%
  mutate(
    sentence_type = factor(substring(bundle, 5)),
    sentence = recode(
      sentence_type,
      "broad-focus" = "(a) Lena lau murin.",
      "narrow-focus" = "(b) Lena lau murin, jo lulen.",
      "polar-q" = "(c) A e lau Lena murin?",
      "narrow-focus-q" = "(d) Çfarë lau Lena?"
      )
  )
```

Now we add info on token repetition.

```{r repet}
repet <- proso %>%
  select(speaker, sentence, token, sentence_type) %>%
  unique() %>%
  ungroup() %>%
  mutate(number = 1) %>%
  group_by(speaker, sentence_type) %>%
  mutate(repetition = cumsum(number)) %>%
  ungroup() %>%
  select(speaker, sentence, token, repetition)

proso <- proso %>%
  left_join(y = repet)
```

We now remove 0s from voiced segments and information that is not needed.

```{r clean}
proso <- proso[!(proso$f0 == 0 & (proso$segment != "tS" & proso$segment != "f")),]

proso <- proso[ , -which(names(proso) %in% c("sl_rowIdx", "db_uuid", "level", "attribute", "start_item_id", "end_item_id", "start_item_seq_idx", "end_item_seq_idx", "type", "sample_rate", "sample_start", "sample_end", "times_rel", "start", "end", "times_norm"))]

columns <- c("speaker", "gender", "segment", "word", "sentence", "sentence_type", "repetition", "f0", "norm_timepoint", "times_orig", "sentence_dur", "token")
proso <- proso[, columns]
```

And we now save the tibble.

```{r save-f0}
saveRDS(proso, file = "./data/dataframes/f0.rds")
```

## Intonation

```{r syl-f0}
syl <- query(db_int, "SYL =~ .*", calcTimes = T) %>%
  filter(labels != "<p:>")

syl_f0 <- get_trackdata(db_int, seglist = syl, ssffTrackName = "F0", cut = 0.5) %>%
  group_by(session, bundle) %>%
  mutate(
    sentence_dur = max(end) - min(start),
    norm_timepoint = ((times_orig - (min(start)))/sentence_dur)
  ) %>%
  rename(f0 = "T1", speaker = "session") %>%
  mutate(
    sentence_type = str_sub(bundle, 5),
    sentence = recode(
      sentence_type,
      "broad-focus" = "(a) Lena lau murin.",
      "narrow-focus" = "(b) Lena lau murin, jo lulen.",
      "polar-q" = "(c) A e lau Lena murin?",
      "narrow-focus-q" = "(d) Çfarë lau Lena?"
      )
  )
syl_f0[syl_f0$labels == "çfar(ë)",]$f0 <- 250

syl <- syl %>%
  group_by(session, bundle) %>%
  mutate(
    sentence_duration = max(end) - min(start),
    start_norm = (start - min(start)) / sentence_duration,
    end_norm = (end - min(start)) / sentence_duration,
    sentence_type = str_sub(bundle, 5),
    sentence = recode(
      sentence_type,
      "broad-focus" = "(a) Lena lau murin.",
      "narrow-focus" = "(b) Lena lau murin, jo lulen.",
      "polar-q" = "(c) A e lau Lena murin?",
      "narrow-focus-q" = "(d) Çfarë lau Lena?"
      )
  )
```

```{r save-syl-f0}
saveRDS(syl_f0, "./data/dataframes/syl_f0.rds")
saveRDS(syl, "./data/dataframes/syl.rds")
```


## Spectral moments (CoG)

### Fricatives

```{r fric}
# Get query list
fric_segs <- query(
  db,
  "[MAU == f|v|T|D|s|z|S|Z|h]",
  bundlePattern = "[0-9]*-(fati|vata|that3|dhat3|salla|zalli|shava|zhaba|han3)"
)
```

```{r fric-dft}
# Get dft in wide format
fric_dft <- get_trackdata(
  db,
  seglist = fric_segs,
  ssffTrackName = "dft",
  resultType = "tibble",
  cut = 0.5
)

fric_dft_l <- convert_wideToLong(fric_dft, calcFreqs = T)
```

```{r fric-moments}
# Get spectral moments
fric_moments <- fric_dft_l %>%
  filter(freq < 10000) %>%
  group_by(labels, sl_rowIdx) %>%
  do(data_frame(moments = moments(.$track_value,.$freq, minval = TRUE))) %>%
  mutate(moment_num = paste0("moment_", 1:(table(sl_rowIdx)))) %>%
  pivot_wider(names_from = "moment_num", values_from = "moments")

fric_moments %>%
  group_by(labels) %>%
  summarise(mean = mean(moment_1), sd = sd(moment_1))
```

```{r save-fric-dft-moments}
saveRDS(fric_dft_l, file = "./data/dataframes/fric_dtf_l.rds")
saveRDS(fric_moments, file = "./data/dataframes/fric_moments.rds")
```

### Affricates

```{r affr}
# Get query list
affr_rels = query(
  db,
  "RELS =~ .*",
  bundlePattern = "[0-9]*-(cica|xixa|5aji|xhaja|qava|gjaku)", 
  calcTimes = T)

affr_segs = requery_hier(
  db,
  affr_rels,
  level = 'MAU')

# Replace start of segments with time of release
affr_segs$start = affr_rels$start
```

```{r affr-dft}
# Get data in wide format
affr_dft = get_trackdata(
  db,
  seglist = affr_segs,
  ssffTrackName = "dft",
  resultType = "tibble",
  cut = 0.5)


affr_dft_l = convert_wideToLong(affr_dft, calcFreqs = T)
```

```{r affr-moments}
# Get spectral moments
affr_moments = affr_dft_l %>%
  filter(freq < 10000) %>%
  group_by(labels, sl_rowIdx) %>%
  do(data_frame(moments = moments(.$track_value,.$freq, minval = TRUE))) %>%
  mutate(moment_num = paste0("moment_", 1:(table(sl_rowIdx)))) %>%
  pivot_wider(names_from = "moment_num", values_from = "moments")

affr_moments %>%
  group_by(labels) %>%
  summarise(mean = mean(moment_1), sd = sd(moment_1))
```


```{r save-affr-dft-moments}
# save dataframes
saveRDS(affr_dft_l, file = "./data/dataframes/affr_dft_l.rds")
saveRDS(affr_moments, file = "./data/dataframes/affr_moments.rds")
```


## Examples

```{r pata}
pata <- query(
  db,
  "[ORT-MAU == pata]",
  bundlePattern = "018-pata",
  sessionPattern = "s04"
)

export_seglistToTxtCollection(db, pata, "./data/varia/vot-example/")
```

```{r qgj}
qgj <- query(
  db,
  "[ORT-MAU == gjaku|qava]",
  bundlePattern = "(044|038).*",
  sessionPattern = "s04"
)

export_seglistToTxtCollection(db, qgj, "./data/varia/qgj-example/")
```

