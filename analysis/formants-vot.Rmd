---
title: "Formants and VOT"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
library(emuR)
library(tidyverse)
```

# Prep data

## Prepare emuDB

```{r emudb}
path <- "./data/alb-ipa_emuDB"
path2 <- "./data/dataframes"
db_handle <- load_emuDB(path, verbose = TRUE)
```

## Formants

First, we query the emuDB to get the vowels in the relevant example words.

```{r vow}
vow <- query(
  db_handle,
  "[MAU == p -> #MAU == e| i | y | u | @ | o | a]",
  bundlePattern = "[0-9]*-(peri|por|puro|pyk3|pik3|p3r|para)"
)
word <- requery_hier(db_handle, vow, "ORT-MAU")
vow$word <- word$labels
```

Now we can get formants from the midpoint of the vowels.

```{r formants}
formants <- get_trackdata(
  db_handle,
  seglist = vow,
  cut = 0.5,
  npoints = 1,
  ssffTrackName = "FORMANTS",
  resultType = "tibble"
)
formants <- formants[ , -which(names(formants) %in% c("T4", "T5"))]
formants <- formants[ which(formants$session != "s03"), ]
```

We now clean, rearrange and save the tibble.

```{r save-formants}
formants$gender <- recode(formants$session, "s01" = "F", "s02" = "M", "s04" = "F", "s05" = "M", "s06" = "M")

formants <- formants %>%
  rename(
    F1 = T1,
    F2 = T2,
    F3 = T3,
    vowel = labels,
    speaker = session
  )

formants <- formants[ , -which(names(formants) %in% c("sl_rowIdx", "db_uuid","session", "level", "attribute", "start_item_id", "end_item_id", "start_item_seq_idx", "end_item_seq_idx", "type", "sample_rate", "times_rel", "times_norm"))]

formants <- formants %>%
  select(speaker, gender, vowel, word, bundle, F1, F2, F3, start, end, sample_start, sample_end, times_orig)

saveRDS(formants, file = file.path(path2, "formants.rds"))
```

## Formants from all vowels

First, we query the emuDB to get the vowels in the relevant example words.

```{r vow-all}
vow_all <- query(
  db_handle,
  "[MAU == p -> #MAU == e| i | y | u | @ | o | a]"
)
word <- requery_hier(db_handle, vow_all, "ORT-MAU")
vow_all$word <- word$labels
```

Now we can get formants from the midpoint of the vowels.

```{r formants-all}
formants_all <- get_trackdata(
  db_handle,
  seglist = vow_all,
  cut = 0.5,
  npoints = 1,
  ssffTrackName = "FORMANTS",
  resultType = "tibble"
)
formants_all <- formants_all[ , -which(names(formants_all) %in% c("T4", "T5"))]
formants_all <- formants_all[ which(formants_all$session != "s03"), ]
```

We now clean, rearrange and save the tibble.

```{r save-formants-all}
formants_all$gender <- recode(formants_all$session, "s01" = "F", "s02" = "M", "s04" = "F", "s05" = "M", "s06" = "M")

formants_all <- formants_all %>%
  rename(
    F1 = T1,
    F2 = T2,
    F3 = T3,
    vowel = labels,
    speaker = session
  )

formants_all <- formants_all[ , -which(names(formants_all) %in% c("sl_rowIdx", "db_uuid","session", "level", "attribute", "start_item_id", "end_item_id", "start_item_seq_idx", "end_item_seq_idx", "type", "sample_rate", "times_rel", "times_norm"))]

formants_all <- formants_all %>%
  select(speaker, gender, vowel, word, bundle, F1, F2, F3, start, end, sample_start, sample_end, times_orig)

saveRDS(formants_all, file = file.path(path2, "formants_all.rds"))
```

## VOT

Quesry the database for the releases.

```{r rels}
rels = query(db_handle, "RELS =~ .*", calcTimes = T)
word2 = requery_hier(db_handle, rels, "ORT-MAU")
rels$word = word2$labels
voi = query(db_handle, "VOI =~ .*", calcTimes = T)
```

Let's calculate VOT.

```{r vot}
rels$tomatch = paste(rels$session, rels$bundle)
voi$tomatch = paste(voi$session, voi$bundle)
m = match(as.character(rels$tomatch), as.character(voi$tomatch))
vot = data.frame(rels, voicing = voi$start[m])
vot$VOT = (vot$voicing - as.numeric(vot$start))
vot$consonant = as.character(substr(vot$word, 1, 1))
```

We now clean, rearrange, and save the tibble.

```{r save-vot}
vot$gender <- recode(vot$session, "s01" = "F", "s02" = "M", "s04" = "F", "s05" = "M", "s06" = "M")

vot <- vot %>%
  rename(
    release = start,
    speaker = session
  )

vot = vot[ , -which(names(vot) %in% c("labels", "end", "db_uuid","session", "level", "attribute", "start_item_id", "end_item_id", "start_item_seq_idx", "end_item_seq_idx", "type", "sample_rate", "tomatch", "sample_start", "sample_end"))]
columns2 <- c("speaker", "gender", "consonant", "word", "bundle", "VOT", "release", "voicing")
vot <- vot[, columns2]

vot <- vot %>%
  select(speaker, gender, consonant, word, bundle, VOT, release, voicing)

saveRDS(vot, file = file.path(path2, "vot.rds"))
```

